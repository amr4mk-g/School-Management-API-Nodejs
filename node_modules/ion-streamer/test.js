

const StreamManager = require('./index.js');
const sm = new StreamManager({prefix: "SL", url: "redis://127.0.0.1:6379"});

let idsList = [];
const consumer = sm.consumer({
    key: 'konafa',
    block: 0,
    keepAlive: true,
    onMessage: (d)=>{
        idsList.push(d.id);
        console.log(`got message`, d)
    },
    onError: (d)=>{console.log(`got error`, d)},
    onClose: ()=>{console.log(`got close`)},
})


const producer = sm.producer();



setInterval(()=>{
    producer.emit({key:'konafa', data: { 
        mxg: JSON.stringify({x: {y:'1'}})
}});
}, 10);
setInterval(()=>{
    producer.emit({key:'konafa', data: { 
        mxg: JSON.stringify({x: {y:'1'}})
}});
}, 10);
setInterval(()=>{
    producer.emit({key:'konafa', data: { 
        mxg: JSON.stringify({x: {y:'1'}})
}});
}, 10);

function hasDuplicates(array) {
    return (new Set(array)).size !== array.length;
}

setTimeout(()=>{
    consumer.close();
    console.log(`hasDuplicates: ${idsList.length} `, hasDuplicates(idsList));
}, 60000)